<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FRH PRO formulaire - v103</title>

  <!-- (1) Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- (2) Leaflet Draw + GeometryUtil CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <!-- CSS pour Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>

  <!-- (3) Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- (4) Leaflet Draw JS -->
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- (5) GeometryUtil -->
  <script src="https://unpkg.com/leaflet-geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>
  <!-- (6) html2canvas + jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Localisation français pour Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Styles généraux */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f2f2f2; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 5px; }
    .page-title { text-align: center; margin-bottom: 30px; }
    /* Navigation onglets */
    .tabNav { display: flex; margin-bottom: 10px; border-bottom: 2px solid #ccc; }
    .tabNav button { background: #c0ddff; border: none; outline: none; padding: 10px 20px; cursor: pointer; font-weight: 600; transition: background-color 0.3s, color 0.3s; border-right: 1px solid #ccc; }
    .tabNav button:last-child { border-right: none; }
    .tabNav button:hover { background-color: #a8d8ff; }
    .tabNav button.activeTab { background-color: #3498db; color: #fff; }
    /* Contenu onglet */
    .tabContent { display: none; padding: 20px 0; }
    .tabContent.activeTab { display: block; }
    /* Logo onglet */
    .tabLogo { display: flex; align-items: center; margin-bottom: 10px; }
    .tabLogo img { max-height: 50px; margin-right: 15px; }
    .tabLogo h2 { margin: 0; font-size: 18px; color: #333; }
    /* Formulaires & sections */
    form { margin-bottom: 20px; }
    .form-section { background-color: #fafafa; padding: 15px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 20px; }
    .form-section h3 { background-color: #e0efff; padding: 8px 12px; border-radius: 4px; margin: 0 0 15px; color: #333; }
    .form-section label { font-weight: 500; margin-top: 5px; display: block; }
    .form-section input[type="text"],
    .form-section input[type="number"],
    .form-section input[type="time"],
    .form-section textarea,
    .form-section select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; margin-top: 5px; }
    .form-section input[disabled] { background-color: #ececec; color: #666; }
    /* Tables */
    table { border: 1px solid #ddd; border-collapse: collapse; width: 100%; text-align: center; }
    table th, table td { padding: 8px; font-size: 14px; border: 1px solid #ddd; }
    table thead { background-color: #f0f0f0; }
    /* Carte et boutons */
    #map-container { position: relative; width: 100%; height: 500px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; overflow: hidden; }
    #map { width: 100%; height: 100%; }
    #drawingCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; pointer-events: none; }
    button { display: inline-block; padding: 10px 15px; font-size: 14px; border: none; border-radius: 4px; background-color: #3498db; color: #fff; cursor: pointer; margin-right: 5px; margin-bottom: 5px; transition: background-color 0.3s, transform 0.2s; }
    button:hover { background-color: #2980b9; transform: scale(1.03); }
    /* Grille checkbox */
    .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 5px 10px; margin-top: 5px; }
    /* Graphique */
    #monthlyBarChart, #monthlyBarChartForced { background-color: #fff; border: 1px solid #ccc; border-radius: 5px; }
    /* Onglet 9 spécifique */
    #tab9.tabContent { background-color: #fff8ef; }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="page-title">Formulaire FRH PRO - Vue Onglets (Gestion Territoires + Primes)</h1>

    <!-- Navigation onglets -->
    <div class="tabNav" id="topTabNav">
      <button type="button" class="tablinks" onclick="openTab(event, 'tab1')">1. Localisation / Données Irradiation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab2')">2. Potentiel de Production</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab3')">3. Production mensuel</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab4')">4. Infos société</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab5')">5. Infos toiture</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab6')">6. Périodes d'utilisation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab7')">7. Conso mensuelle</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab8')">8. Préconisation</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab9')">9. Préconisation Sélection</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab10')">10. Commentaires</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab11')">11. Paramètres</button>
      <button type="button" class="tablinks" onclick="openTab(event, 'tab12')">12. Plan de trésorerie</button>
    </div>

    <!-- Formulaire global -->
    <form id="userForm">
      <!-- Onglet 1 : Localisation / Données Irradiation -->
      <div id="tab1" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Localisation / Données Irradiation</h2>
        </div>
        <label for="address">Adresse :</label>
        <input type="text" id="address" name="address" placeholder="Entrez une adresse" required />
        <button type="button" id="addressSearchBtn">Rechercher</button>
        <button type="button" id="toggleDrawingButton">Activer le dessin (main levée)</button>
        <button type="button" id="toggleMeasureButton">Mesurer une surface</button>
        <div id="map-container">
          <div id="map"></div>
          <canvas id="drawingCanvas"></canvas>
        </div>
        <div class="form-section">
          <h3>Données irradiation</h3>
          <label for="latitudeIrr">Latitude :</label>
          <input type="text" id="latitudeIrr" name="latitudeIrr" readonly />
          <label for="longitudeIrr">Longitude :</label>
          <input type="text" id="longitudeIrr" name="longitudeIrr" readonly />
          <label for="orientationIrr">Orientation :</label>
          <select id="orientationIrr" name="orientationIrr">
            <option value="0">SUD (0°)</option>
            <option value="-90">EST (-90°)</option>
            <option value="90">OUEST (90°)</option>
            <option value="-45">SUD-EST (-45°)</option>
            <option value="45">SUD-OUEST (45°)</option>
          </select>
          <label for="orientation">Orientation (vrai angle °) :</label>
          <input type="text" id="orientation" name="orientation" readonly />
          <label for="angleIrr">Angle (°) :</label>
          <input type="number" id="angleIrr" name="angleIrr" value="35" />
          <label for="productible">Productible :</label>
          <input type="text" id="productible" name="productible" placeholder="kWh/kWc/an" readonly/>
          <label for="territory">Territoire détecté :</label>
          <input type="text" id="territory" name="territory" disabled />
          <button type="button" id="calculateIrrButton">Calculer le productible</button>
        </div>
      </div>

      <!-- Onglet 2 : Potentiel de production -->
      <div id="tab2" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Potentiel de Production</h2>
        </div>
        <div class="form-section">
          <h3>Potentiel de production</h3>
          <label for="exclusionPercent">% surface exclusion :</label>
          <input type="number" id="exclusionPercent" name="exclusionPercent" value="0" />
          <label for="puissancePanneau">Puissance du panneau :</label>
          <select id="puissancePanneau" name="puissancePanneau">
            <option value="420" selected>420 Wc</option>
            <option value="440">440 Wc</option>
            <option value="500">500 Wc</option>
          </select>
          <label for="nombrePVMax">Nombre de PV max :</label>
          <input type="text" id="nombrePVMax" name="nombrePVMax" readonly />
          <label for="puissanceMaxPV">Puissance max PV (kWc) :</label>
          <input type="text" id="puissanceMaxPV" name="puissanceMaxPV" readonly />
          <label for="productionInstall">Production en kWh de l'installation :</label>
          <input type="text" id="productionInstall" name="productionInstall" readonly />
        </div>
      </div>

      <!-- Onglet 3 : Production mensuel -->
      <div id="tab3" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Production mensuel</h2>
        </div>
        <div class="form-section">
          <h3>Production mensuel</h3>
          <table id="monthlyProductionTable">
            <thead>
              <tr>
                <th>Mois</th>
                <th>Production mensuelle (kWh)</th>
              </tr>
            </thead>
            <tbody>
              <!-- Remplissage dynamique -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Onglet 4 : Infos société -->
      <div id="tab4" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la société</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la société</h3>
          <label for="Adresse">Adresse entrée :</label>
          <input type="text" id="Adresse" name="Adresse" readonly />
          <label for="companyName">Société :</label>
          <input type="text" id="companyName" name="companyName"/>
          <label for="activity">Activité :</label>
          <input type="text" id="activity" name="activity"/>
          <label for="Nom">Nom :</label>
          <input type="text" id="Nom" name="Nom"/>
          <label for="Prénom">Prénom :</label>
          <input type="text" id="Prénom" name="Prénom"/>
          <label for="Statut">Statut :</label>
          <input type="text" id="Statut" name="Statut"/>
          <label for="Propietaire/Locataire">Propietaire/Locataire :</label>
          <select id="Propietaire/Locataire" name="Propietaire/Locataire">
            <option value="" disabled selected>indiquer si propriétaire ou locataire</option>
            <option value="Proprietaire">Proprietaire</option>
            <option value="Locataire">Locataire</option>
          </select>
          <label for="Annees presence">Annees presence :</label>
          <input type="text" id="Annees presence" name="Annees presence" placeholder="Entrez le nombre d'années de présence" />
        </div>
      </div>

      <!-- Onglet 5 : Infos toiture -->
      <div id="tab5" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Informations sur la toiture</h2>
        </div>
        <div class="form-section">
          <h3>Informations sur la toiture</h3>
          <label for="Surface toiture">Surface toiture (m²) :</label>
          <input type="number" id="Surface toiture" name="Surface toiture" />
          <label for="Partage sa toiture">Partage sa toiture? :</label>
          <select id="Partage sa toiture" name="Partage sa toiture">
            <option value="" disabled selected>indiquer si la toiture est partagée</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>
          <label for="Type de toiture">Type de toiture :</label>
          <select id="Type de toiture" name="Type de toiture">
            <option value="" disabled selected>Choisissez un type de toiture</option>
            <option value="2 pentes">2 pentes</option>
            <option value="1 pente">1 pente</option>
            <option value="Toit plat">Toit plat</option>
          </select>
          <label for="Pente toiture">Pente toiture (°) :</label>
          <input type="number" id="Pente toiture" name="Pente toiture" />
          <label for="Type de couverture">Type de couverture :</label>
          <select id="Type de couverture" name="Type de couverture">
            <option value="" disabled selected>Choisissez un type de couverture</option>
            <option value="Bacs acier">Bacs acier</option>
            <option value="Fibro ciment">Fibro ciment</option>
            <option value="Tuiles">Tuiles</option>
            <option value="Béton">Béton</option>
          </select>
          <label for="Type de charpente">Type de charpente :</label>
          <select id="Type de charpente" name="Type de charpente">
            <option value="" disabled selected>Choisissez un type de charpente</option>
            <option value="Metallique">Métallique</option>
            <option value="Bois">Bois</option>
          </select>
          <label for="Translucides">Présence de translucides :</label>
          <select id="Translucides" name="Translucides">
            <option value="" disabled selected>Présence de translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>
          <label for="Couvrir Translucides">Couvrir Translucides :</label>
          <select id="Couvrir Translucides" name="Couvrir Translucides">
            <option value="" disabled selected>Couvrir translucides</option>
            <option value="Oui">Oui</option>
            <option value="Non">Non</option>
          </select>
        </div>
      </div>

      <!-- Onglet 6 : Périodes d'utilisation -->
      <div id="tab6" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Périodes d'utilisation</h2>
        </div>
        <div class="form-section">
          <h3>Périodes d'utilisation</h3>
          <h4>Mois de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="moisConges[]" value="Janvier" />Janvier</label>
            <label><input type="checkbox" name="moisConges[]" value="Février" />Février</label>
            <label><input type="checkbox" name="moisConges[]" value="Mars" />Mars</label>
            <label><input type="checkbox" name="moisConges[]" value="Avril" />Avril</label>
            <label><input type="checkbox" name="moisConges[]" value="Mai" />Mai</label>
            <label><input type="checkbox" name="moisConges[]" value="Juin" />Juin</label>
            <label><input type="checkbox" name="moisConges[]" value="Juillet" />Juillet</label>
            <label><input type="checkbox" name="moisConges[]" value="Août" />Août</label>
            <label><input type="checkbox" name="moisConges[]" value="Septembre" />Septembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Octobre" />Octobre</label>
            <label><input type="checkbox" name="moisConges[]" value="Novembre" />Novembre</label>
            <label><input type="checkbox" name="moisConges[]" value="Décembre" />Décembre</label>
          </div>
          <h4>Jours de congés</h4>
          <div class="checkbox-grid">
            <label><input type="checkbox" name="joursConges[]" value="Lundi" />Lundi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mardi" />Mardi</label>
            <label><input type="checkbox" name="joursConges[]" value="Mercredi" />Mercredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Jeudi" />Jeudi</label>
            <label><input type="checkbox" name="joursConges[]" value="Vendredi" />Vendredi</label>
            <label><input type="checkbox" name="joursConges[]" value="Samedi" />Samedi</label>
            <label><input type="checkbox" name="joursConges[]" value="Dimanche" />Dimanche</label>
          </div>
          <label for="heureDebut">Heure début travail :</label>
          <input type="time" id="heureDebut" name="heureDebut" />
          <label for="heureFin">Heure fin :</label>
          <input type="time" id="heureFin" name="heureFin" />
          <label for="Puissance compteur">Puissance compteur (Kva) :</label>
          <input type="number" id="Puissance compteur" name="Puissance compteur" />
        </div>
      </div>

      <!-- Onglet 7 : Conso mensuelle -->
      <div id="tab7" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Consommation mensuelle</h2>
        </div>
        <div id="consumptionTableContainer" class="form-section">
          <h3>Consommation mensuelle</h3>
          <table id="consumptionTable">
            <thead>
              <tr>
                <th style="width: 20%;">Mois</th>
                <th style="width: 25%;">Consommation (€)</th>
                <th style="width: 25%;">Consommation (kWh)</th>
                <th style="width: 30%;">Coût par kWh (€)</th>
              </tr>
            </thead>
            <tbody id="consumptionTableBody">
              <tr>
                <td><strong>Total annuel</strong></td>
                <td id="totalEuros">-</td>
                <td id="totalKwh">-</td>
                <td id="totalCostPerKwh">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Onglet 8 : Préconisation -->
      <div id="tab8" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Préconisation</h2>
        </div>
        <div class="form-section">
          <h3>Préconisation</h3>
          <label for="annualPriceIncrease">Augmentation annuelle du prix de l'électricité (%):</label>
          <input type="number" step="0.1" id="annualPriceIncrease" name="annualPriceIncrease" value="5" />
          <label for="tarifRachat">Tarif de rachat du surplus (€/kWh) :</label>
          <input type="number" step="0.0001" id="tarifRachat" name="tarifRachat" value="0.0761" disabled />
          <label for="ratioDiurne">Ratio diurne (%) :</label>
          <input type="number" id="ratioDiurne" name="ratioDiurne" value="60" min="0" max="100" />
          <label><input type="checkbox" id="showKwhColumns" name="showKwhColumns" /> Kwh visible</label>
          <button type="button" id="calculatePreconisation">Calculer la préconisation</button>
          <h4>Détails par mois (année 1)</h4>
          <table id="preconisationMonthlyTable"></table>
          <h4>Graphique (Détails par mois)</h4>
          <canvas id="monthlyBarChart" width="600" height="300"></canvas>
          <h4>Projection sur 20 ans</h4>
          <table id="preconisationTable">
            <thead>
              <tr>
                <th>Année</th>
                <th>Facture Sans Centrale</th>
                <th>Économies Autoconso</th>
                <th>Facture Avec Centrale</th>
                <th>Gains Revente</th>
                <th>Prime (année 2)</th>
                <th>Total Économies</th>
                <th>Cumul economies</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="1">Totaux sur 20 ans</th>
                <td id="totalSansPv">-</td>
                <td id="totalAuto">-</td>
                <td id="totalAvecPv">-</td>
                <td id="totalRevente">-</td>
                <td id="totalPrime">-</td>
                <td id="totalEconomies">-</td>
              </tr>
            </tfoot>
          </table>
          <div id="preconisationSummary" style="margin-top:10px;">
            <p><strong>Puissance préconisée :</strong> <span id="puissanceReco">-</span> kWc</p>
            <p><strong>Coût de l'installation :</strong> <span id="coutInstallation">-</span> €</p>
            <p><strong>Prime :</strong> <span id="primeValue">-</span> €</p>
            <p><strong>Coût réel de l'installation :</strong> <span id="coutReelInstallation">-</span> €</p>
            <p><strong>Gain total (sans inv.) :</strong> <span id="gainSansInv">-</span> €</p>
            <p><strong>Gain total (avec inv.) :</strong> <span id="gainAvecInv">-</span> €</p>
            <p><strong>ROI (années) :</strong> <span id="roiResult">-</span></p>
          </div>
        </div>
      </div>

      <!-- Onglet 9 : Préconisation Sélection -->
      <div id="tab9" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Préconisation Sélection</h2>
        </div>
        <div class="form-section">
          <h3>Préconisation Sélection</h3>
          <label for="forcedPower">Installation choisie (kWc) :</label>
          <input type="number" id="forcedPower" name="forcedPower" value="10" min="1" />
          <button type="button" id="applyForcedPreconisationBtn">Calculer la préconisation choisie</button>
          <h4>Détails par mois (année 1) - Sélection</h4>
          <table id="preconisationMonthlyTableForced"></table>
          <h4>Graphique (Détails par mois) - Sélection</h4>
          <canvas id="monthlyBarChartForced" width="600" height="300"></canvas>
          <h4>Projection sur 20 ans - Sélection</h4>
          <table id="preconisationTableForced">
            <thead>
              <tr>
                <th>Année</th>
                <th>Facture Sans Centrale</th>
                <th>Économies Autoconso</th>
                <th>Facture Avec Centrale</th>
                <th>Gains Revente</th>
                <th>Prime (année 2)</th>
                <th>Total Économies</th>
                <th>Cumul economies</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="1">Totaux sur 20 ans</th>
                <td id="totalSansPvForced">-</td>
                <td id="totalAutoForced">-</td>
                <td id="totalAvecPvForced">-</td>
                <td id="totalReventeForced">-</td>
                <td id="totalPrimeForced">-</td>
                <td id="totalEconomiesForced">-</td>
              </tr>
            </tfoot>
          </table>
          <div id="preconisationSummaryForced" style="margin-top:10px;">
            <p><strong>Puissance préconisée (Sélection) :</strong> <span id="puissanceRecoForced">-</span> kWc</p>
            <p><strong>Coût de l'installation (Sélection) :</strong> <span id="coutInstallationForced">-</span> €</p>
            <p><strong>Prime :</strong> <span id="primeValueForced">-</span> €</p>
            <p><strong>Coût réel de l'installation :</strong> <span id="coutReelInstallationForced">-</span> €</p>
            <p><strong>Gain total (sans inv.) :</strong> <span id="gainSansInvForced">-</span> €</p>
            <p><strong>Gain total (avec inv.) :</strong> <span id="gainAvecInvForced">-</span> €</p>
            <p><strong>ROI (années) :</strong> <span id="roiResultForced">-</span></p>
          </div>
        </div>
      </div>

      <!-- Onglet 10 : Commentaires -->
      <div id="tab10" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Commentaires</h2>
        </div>
        <div class="form-section">
          <h3>RDV</h3>
          <label for="rdvDate">Date du RDV :</label>
          <input type="text" id="rdvDate" name="rdvDate" placeholder="Choisissez une date" />
          <label for="rdvTime">Heure du RDV :</label>
          <input type="time" id="rdvTime" name="rdvTime" />
        </div>
        <div class="form-section">
          <h3>Commentaires</h3>
          <label for="comments">Commentaires :</label>
          <textarea id="comments" name="comments" placeholder="Entrez vos commentaires"></textarea>
        </div>
        <input type="file" id="mapCaptureFile" accept="image/png, image/jpeg" style="display:none;" />
        <label for="mapCaptureFile" style="cursor:pointer; color:blue; text-decoration:underline;">Sélectionner la capture</label>
        <br/><br/>
        <div style="margin-bottom:15px;">
          <button type="button" id="exportPDFBtn">Exporter en PDF</button>
          <button type="button" id="saveToFile">Télécharger les données</button>
          <input type="file" id="loadFromFile" style="display: none;" />
          <button type="button" id="uploadFile">Charger un fichier</button>
        </div>
      </div>

      <!-- Onglet 11 : Paramètres -->
      <div id="tab11" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Paramètres</h2>
        </div>
        <div class="form-section">
          <h3>Charges photovoltaïques courantes</h3>
          <label for="assurance_dommages">Assurance dommages et RCP % :</label>
          <input type="text" id="assurance_dommages" name="assurance_dommages" value="0.20" />
          <label for="assurance_perte">Assurance perte d'exploitation % :</label>
          <input type="text" id="assurance_perte" name="assurance_perte" value="0.30" />
          <label for="cout_maintenance">Coût maintenance préventive/curative/nettoyage (€/kWc) :</label>
          <input type="text" id="cout_maintenance" name="cout_maintenance" value="5.97" />
        </div>
        <div class="form-section">
          <h3>Evolution liée au vieillissement de la centrale</h3>
          <label for="cout_reparations">Coût réparations courantes % :</label>
          <input type="text" id="cout_reparations" name="cout_reparations" value="0.19" />
          <label for="cout_changement_onduleurs">Coût changement onduleurs :</label>
          <input type="text" id="cout_changement_onduleurs" name="cout_changement_onduleurs" value="" placeholder="Saisir valeur" />
          <label for="perte_puissance">Perte puissance annuelle des panneaux % :</label>
          <input type="text" id="perte_puissance" name="perte_puissance" value="0.60" />
        </div>
        <div class="form-section">
          <h3>Paramètres financiers généraux</h3>
          <label for="inflation_estimee">Inflation estimée (%/an) :</label>
          <input type="text" id="inflation_estimee" name="inflation_estimee" value="2.00" />
          <label for="taux_emprunt">Taux emprunt % :</label>
          <input type="text" id="taux_emprunt" name="taux_emprunt" value="2.00" />
          <label for="duree_pret">Durée prêt en années :</label>
          <input type="number" id="duree_pret" name="duree_pret" value="" placeholder="Saisir durée" />
          <label for="taux_autofinancement">Taux autofinancement :</label>
          <input type="text" id="taux_autofinancement" name="taux_autofinancement" value="" placeholder="Saisir taux" />
          <label for="index_leasing">Index du leasing :</label>
          <input type="text" id="index_leasing" name="index_leasing" value="1.837" />
          <label for="duree_leasing">Durée du leasing (mois) :</label>
          <input type="number" id="duree_leasing" name="duree_leasing" value="72" />
        </div>
      </div>

      <!-- Onglet 12 : Plan de trésorerie -->
      <div id="tab12" class="tabContent">
        <div class="tabLogo">
          <img src="https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png" alt="FRH Pro Logo"/>
          <h2>Plan de trésorerie</h2>
        </div>
        <div class="form-section">
          <h3>Choix du mode de financement et du scénario</h3>
          <label for="financementMode">Mode de financement :</label>
          <select id="financementMode" name="financementMode">
            <option value="banque">Financement bancaire</option>
            <option value="leasing">Leasing</option>
          </select>
          <label for="scenarioPlan">Scénario de préconisation :</label>
          <select id="scenarioPlan" name="scenarioPlan">
            <option value="standard">Préconisation standard</option>
            <option value="selection">Préconisation Sélection</option>
          </select>
          <button type="button" id="calculateTresorerieBtn">Calculer le plan de trésorerie</button>
        </div>
        <div class="form-section">
          <h3>Plan de trésorerie (Annuel)</h3>
          <table id="planTresorerieTable">
            <thead>
              <tr id="planTresorerieHeader">
                <!-- En-têtes définis par le script -->
              </tr>
            </thead>
            <tbody id="planTresorerieBody">
              <!-- Lignes générées dynamiquement -->
            </tbody>
          </table>
        </div>
      </div>
    </form>
  </div>

  <!-- Scripts -->
  <script>
    /********* Gestion des onglets *********/
    function openTab(evt, tabId) {
      const tabs = document.getElementsByClassName("tabContent");
      for (let i = 0; i < tabs.length; i++) { tabs[i].classList.remove("activeTab"); }
      const tabButtons = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tabButtons.length; i++) { tabButtons[i].classList.remove("activeTab"); }
      document.getElementById(tabId).classList.add("activeTab");
      evt.currentTarget.classList.add("activeTab");
      if (tabId === 'tab1') { setTimeout(() => { map.invalidateSize(); }, 300); }
    }

    /********* Variables globales & données intégrées *********/
    let monthlyProductionData = [];
    const primeTarifsData = {
      "France Metropolitaine": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1269 },
          { "min": 4, "max": 9, "tarif": 0.1269 },
          { "min": 10, "max": 36, "tarif": 0.0761 },
          { "min": 37, "max": 100, "tarif": 0.0761 },
          { "min": 101, "max": 500, "tarif": 0.0761 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 0.22 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.16 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.19 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.10 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.10 }
        ]
      },
      "Corse": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1645 },
          { "min": 4, "max": 9, "tarif": 0.1645 },
          { "min": 10, "max": 36, "tarif": 0.0893 },
          { "min": 37, "max": 100, "tarif": 0.0893 },
          { "min": 101, "max": 500, "tarif": 0.1319 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 1.27 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.72 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.37 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.48 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
        ]
      },
      "Reunion": {
        "tarif_rachat": [
          { "min": 0, "max": 3, "tarif": 0.1739 },
          { "min": 4, "max": 9, "tarif": 0.1739 },
          { "min": 10, "max": 36, "tarif": 0.0893 },
          { "min": 37, "max": 100, "tarif": 0.0893 },
          { "min": 101, "max": 500, "tarif": 0.1465 }
        ],
        "primes": [
          { "min": 0, "max": 3, "montant_euros_par_wc": 1.64 },
          { "min": 4, "max": 9, "montant_euros_par_wc": 0.98 },
          { "min": 10, "max": 36, "montant_euros_par_wc": 0.58 },
          { "min": 37, "max": 100, "montant_euros_par_wc": 0.40 },
          { "min": 101, "max": 500, "montant_euros_par_wc": 0.00 }
        ]
      }
    };

    function detectTerritoryFromZip(cpStr) {
      if(!cpStr || cpStr.length < 2) return "France Metropolitaine";
      let prefix2 = cpStr.substring(0,2);
      if(prefix2 === "20") return "Corse";
      if(prefix2 === "97") return "Reunion";
      return "France Metropolitaine";
    }

    /********* INITIALISATION DES ONGLETS 1 à 11 *********/
    window.addEventListener("load", function() {
      const firstTabButton = document.querySelector(".tabNav button");
      if (firstTabButton) { firstTabButton.click(); }
      const consumptionTableBody = document.getElementById("consumptionTableBody");
      const months = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
      const lastRow = consumptionTableBody.querySelector("tr");
      months.forEach((month, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${month}</td>
          <td><input type="number" id="euros_${index}" name="euros_${index}" placeholder="€" style="width: 90%;" oninput="calculateCost(${index})" /></td>
          <td><input type="number" id="kwh_${index}" name="kwh_${index}" placeholder="kWh" style="width: 90%;" oninput="calculateCost(${index})" /></td>
          <td id="costPerKwh_${index}">-</td>
        `;
        consumptionTableBody.insertBefore(row, lastRow);
      });
    });

    /********* INITIALISATION DE LA CARTE *********/
    const map = L.map("map").setView([48.8566, 2.3522], 18);
    const tileLayer = L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
      maxZoom: 20,
      subdomains: ["mt0", "mt1", "mt2", "mt3"],
      attribution: "© Google"
    });
    tileLayer.addTo(map);
    let searchMarker = null;

    /********* DESSIN SUR CANVAS *********/
    const drawingCanvas = document.getElementById("drawingCanvas");
    const ctx = drawingCanvas.getContext("2d");
    const AdresseField = document.getElementById("Adresse");
    let drawing = false, drawingEnabled = false;
    const toggleDrawingButton = document.getElementById("toggleDrawingButton");
    toggleDrawingButton.addEventListener("click", () => {
      drawingEnabled = !drawingEnabled;
      drawingCanvas.style.pointerEvents = drawingEnabled ? "auto" : "none";
      toggleDrawingButton.textContent = drawingEnabled ? "Désactiver le dessin" : "Activer le dessin (main levée)";
    });
    function resizeCanvas() {
      drawingCanvas.width = drawingCanvas.offsetWidth;
      drawingCanvas.height = drawingCanvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    drawingCanvas.addEventListener("mousedown", (e) => {
      if (!drawingEnabled) return;
      drawing = true;
      ctx.beginPath();
      const rect = drawingCanvas.getBoundingClientRect();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });
    drawingCanvas.addEventListener("mouseup", () => { if(drawingEnabled){ drawing = false; ctx.beginPath(); } });
    drawingCanvas.addEventListener("mousemove", (e) => {
      if (!drawing || !drawingEnabled) return;
      ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "red";
      const rect = drawingCanvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
    });

    /********* OUTILS LEAFLET DRAW *********/
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({
      draw: { marker: false, circle: false, circlemarker: false, polygon: true, rectangle: true, polyline: true },
      edit: { featureGroup: drawnItems }
    });
    let measureActive = false;
    const measureButton = document.getElementById("toggleMeasureButton");
    measureButton.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) { map.addControl(drawControl); measureButton.textContent = "Terminer la mesure"; }
      else { map.removeControl(drawControl); measureButton.textContent = "Mesurer une surface"; }
    });
    function computeBearing(lat1, lng1, lat2, lng2) {
      const toRad = v => v * Math.PI / 180, toDeg = v => v * 180 / Math.PI;
      const dLon = toRad(lng2 - lng1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) - Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }
    map.on(L.Draw.Event.CREATED, function(e) {
      const layer = e.layer;
      drawnItems.addLayer(layer);
      if (e.layerType === "polygon" || e.layerType === "rectangle") {
        let latLngs = layer.getLatLngs();
        if (Array.isArray(latLngs[0])) { latLngs = latLngs[0]; }
        const area = L.GeometryUtil.geodesicArea(latLngs);
        const areaInt = Math.round(area);
        alert(`Surface mesurée : ${areaInt.toLocaleString('fr-FR')} m²`);
        document.getElementById("Surface toiture").value = areaInt;
        updateProductionPotential();
      } else if (e.layerType === "polyline") {
        const latLngs = layer.getLatLngs();
        if (latLngs.length < 2) { alert("Tracez au moins 2 points pour la ligne d'orientation."); return; }
        const first = latLngs[0], last = latLngs[latLngs.length - 1];
        const angle = computeBearing(first.lat, first.lng, last.lat, last.lng);
        let aspectVal = angle - 180;
        aspectVal = (aspectVal + 180 + 360) % 360 - 180;
        document.getElementById("orientationIrr").value = aspectVal.toFixed(1);
        document.getElementById("orientation").value = aspectVal.toFixed(1);
        alert(`Orientation déterminée: ${aspectVal.toFixed(1)}° (0 = Sud)`);
        drawnItems.removeLayer(layer);
      }
    });

    /********* RECHERCHE D'ADRESSE + TERRITOIRE *********/
    const addressSearchBtn = document.getElementById("addressSearchBtn");
    addressSearchBtn.addEventListener("click", searchAddress);
    function searchAddress() {
      const address = document.getElementById("address").value;
      if(!address) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(r => r.json())
        .then(data => {
          if(data.length > 0) {
            const { lat, lon, display_name } = data[0];
            map.setView([lat, lon], 18);
            AdresseField.value = address;
            if(searchMarker){ map.removeLayer(searchMarker); }
            searchMarker = L.marker([lat, lon]).addTo(map);
            searchMarker.bindPopup(`Adresse trouvée : ${address}`).openPopup();
            document.getElementById("latitudeIrr").value = lat;
            document.getElementById("longitudeIrr").value = lon;
            let foundCP = (data[0].address && data[0].address.postcode) ? data[0].address.postcode : null;
            if(!foundCP) {
              const patternCP = /\b(\d{4,5})\b/;
              const match = display_name.match(patternCP);
              if(match) foundCP = match[1];
            }
            document.getElementById("territory").value = foundCP ? detectTerritoryFromZip(foundCP) : "France Metropolitaine";
          } else { alert("Adresse introuvable."); }
        })
        .catch(err => { console.error("Erreur recherche adresse:", err); alert("Une erreur est survenue lors de la recherche."); });
    }

    /********* CALCUL PRODUCTIBLE (API PVGIS) *********/
    async function getProductible(lat, lon, aspectValue) {
      const angleValue = parseFloat(document.getElementById("angleIrr").value) || 35;
      const originalUrl = `https://re.jrc.ec.europa.eu/api/v5_2/PVcalc?outputformat=basic&lat=${lat}&lon=${lon}&raddatabase=PVGIS-SARAH2&peakpower=1&loss=14&pvtechchoice=crystSi&angle=${angleValue}&aspect=${aspectValue}&usehorizon=1`;
      const proxyUrl = `https://corsproxy.io/?key=a32495b2&url=${encodeURIComponent(originalUrl)}`;
      try {
        const response = await fetch(proxyUrl);
        if(!response.ok) return null;
        const text = await response.text();
        const lines = text.split("\n");
        let yearProduction = null, tempMonthly = [];
        for (const line of lines) {
          const cleanLine = line.trim();
          if(!cleanLine) continue;
          if(cleanLine.includes("Year")){
            const parts = cleanLine.split("\t").map(s => s.trim());
            yearProduction = parseFloat(parts[1]);
          } else if (/^\d+\s/.test(cleanLine)){
            const parts = cleanLine.split("\t").map(s => s.trim());
            if(parts.length >= 3) {
              const monthNumber = parseInt(parts[0], 10);
              const E_mValue = parseFloat(parts[2]);
              tempMonthly.push({ month: monthNumber, E_m: E_mValue });
            }
          }
        }
        monthlyProductionData = tempMonthly;
        return { yearProduction, monthlyProduction: tempMonthly };
      } catch (e) { console.error(e); return null; }
    }
    const calculateIrrButton = document.getElementById("calculateIrrButton");
    calculateIrrButton.addEventListener("click", async () => {
      const lat = parseFloat(document.getElementById("latitudeIrr").value);
      const lon = parseFloat(document.getElementById("longitudeIrr").value);
      const aspectValue = parseFloat(document.getElementById("orientation").value);
      if(isNaN(lat) || isNaN(lon)){
        alert("Veuillez renseigner la latitude et la longitude.");
        return;
      }
      const result = await getProductible(lat, lon, aspectValue);
      if(result && result.yearProduction !== null) {
        document.getElementById("productible").value = result.yearProduction.toLocaleString('fr-FR');
        fillMonthlyProductionTable(result.monthlyProduction);
      } else { alert("Impossible de récupérer le productible."); }
      updateProductionPotential();
    });
    function fillMonthlyProductionTable(monthlyData) {
      const tableBody = document.querySelector("#monthlyProductionTable tbody");
      tableBody.innerHTML = "";
      const moisNoms = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
      monthlyData.forEach(item => {
        const row = document.createElement("tr");
        const monthCell = document.createElement("td");
        const productionCell = document.createElement("td");
        const idx = item.month - 1;
        monthCell.textContent = (idx >= 0 && idx < 12) ? moisNoms[idx] : `Mois ${item.month}`;
        productionCell.textContent = item.E_m ? item.E_m.toLocaleString('fr-FR') : "-";
        row.appendChild(monthCell);
        row.appendChild(productionCell);
        tableBody.appendChild(row);
      });
    }

    /********* CALCUL POTENTIEL DE PRODUCTION *********/
    function updateProductionPotential(){
      const surfaceStr = (document.getElementById("Surface toiture").value || "").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");
      const exclStr = document.getElementById("exclusionPercent").value || "0";
      const panelPowerStr = document.getElementById("puissancePanneau").value || "420";
      const productibleStr = (document.getElementById("productible").value || "").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");
      const surface = parseFloat(surfaceStr) || 0;
      const exclusionPercent = parseFloat(exclStr) || 0;
      const panelPower = parseFloat(panelPowerStr) || 420;
      const productibleVal = parseFloat(productibleStr) || 0;
      const surfaceUtile = surface * (1 - exclusionPercent/100);
      const nbPanels = Math.floor(surfaceUtile / 2);
      const puissanceMaxW = nbPanels * panelPower;
      const puissanceMaxKW = Math.round(puissanceMaxW / 1000);
      const production = Math.round(puissanceMaxKW * productibleVal);
      document.getElementById("nombrePVMax").value = nbPanels.toLocaleString('fr-FR');
      document.getElementById("puissanceMaxPV").value = puissanceMaxKW.toLocaleString('fr-FR');
      document.getElementById("productionInstall").value = production.toLocaleString('fr-FR');
    }
    const surfaceInput = document.getElementById("Surface toiture");
    const exclInput = document.getElementById("exclusionPercent");
    const panelSelect = document.getElementById("puissancePanneau");
    const productibleInput = document.getElementById("productible");
    surfaceInput.addEventListener("input", updateProductionPotential);
    exclInput.addEventListener("input", updateProductionPotential);
    panelSelect.addEventListener("change", updateProductionPotential);
    productibleInput.addEventListener("input", updateProductionPotential);

    /********* EXPORT PDF avec capture de la carte *********/
    const mapCaptureFileInput = document.getElementById("mapCaptureFile");
    const exportPDFBtn = document.getElementById("exportPDFBtn");
    let mapCaptureDataURL = null, mapCaptureFormat = null;
    mapCaptureFileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if(!file){ mapCaptureDataURL = null; mapCaptureFormat = null; return; }
      const reader = new FileReader();
      reader.onload = (e) => {
        mapCaptureDataURL = e.target.result;
        if(file.type.toLowerCase().includes("jpeg")) { mapCaptureFormat = "JPEG"; }
        else if(file.type.toLowerCase().includes("png")) { mapCaptureFormat = "PNG"; }
        else { mapCaptureFormat = "PNG"; }
        alert("Capture de carte sélectionnée !");
      };
      reader.readAsDataURL(file);
    });
    exportPDFBtn.addEventListener("click", exportStudyReportPDF);
    async function exportStudyReportPDF(){
      try {
        if(!mapCaptureDataURL){
          alert("Veuillez sélectionner une capture de carte.");
          return;
        }
        const drawingCanvas = document.getElementById("drawingCanvas");
        let drawingCanvasParent = drawingCanvas.parentNode;
        drawingCanvasParent.removeChild(drawingCanvas);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const pageWidth = pdf.internal.pageSize.getWidth();
        pdf.setFillColor(0,92,160);
        pdf.rect(0,0,pageWidth,25,"F");
        const frhProLogoUrl = "https://raw.githubusercontent.com/m2arek/parallele/main/frh_pro_logo.png";
        const frhProLogo = new Image();
        frhProLogo.crossOrigin = "Anonymous";
        frhProLogo.src = frhProLogoUrl;
        await new Promise(resolve => frhProLogo.onload = resolve);
        pdf.addImage(frhProLogo, "PNG", 10,5,30,30);
        pdf.setTextColor(255,255,255);
        pdf.setFontSize(22);
        pdf.text("FRH PRO", pageWidth/2,17, { align: "center" });
        pdf.setTextColor(0,0,0);
        pdf.setFontSize(16);
        const companyName = document.getElementById("companyName")?.value || "";
        const mainTitle = `Rapport d'étude photovoltaïque\n${companyName}`;
        const titleLines = pdf.splitTextToSize(mainTitle, pageWidth-20);
        pdf.text(titleLines, pageWidth/2,40, { align: "center" });
        let yPos = 50;
        const imgTemp = new Image();
        imgTemp.src = mapCaptureDataURL;
        await new Promise(resolve => imgTemp.onload = resolve);
        const pdfWidth = pageWidth - 30;
        const ratio = imgTemp.height / imgTemp.width;
        const pdfHeight = pdfWidth * ratio;
        pdf.addImage(mapCaptureDataURL, mapCaptureFormat, 15, yPos, pdfWidth, pdfHeight);
        yPos += pdfHeight + 10;
        pdf.setFontSize(12);
        const addressVal = document.getElementById("address")?.value || "";
        const latVal = document.getElementById("latitudeIrr")?.value || "";
        const lonVal = document.getElementById("longitudeIrr")?.value || "";
        const productibleVal = document.getElementById("productible")?.value || "";
        pdf.text(`Client : ${companyName}`,15,yPos);
        yPos += 6;
        pdf.text(`Adresse : ${addressVal}`,15,yPos);
        yPos += 6;
        pdf.text(`Coordonnées : lat=${latVal}, lon=${lonVal}`,15,yPos);
        yPos += 6;
        pdf.text(`Productible : ${parseFloat(productibleVal).toLocaleString("fr-FR")} kWh/kWc/an`,15,yPos);
        yPos += 10;
        let scenarioChoice = prompt("Choisir la préconisation à utiliser dans le rapport\n'1' => Préconisation standard\n'2' => Préconisation Sélection");
        if(!scenarioChoice) return;
        scenarioChoice = scenarioChoice.trim();
        // Détermination des IDs en fonction du scénario
        let monthlyTableId, monthlyChartId, twentyYearsId, puissanceId, coutInstId, primeId, coutReelId, gainSansId, gainAvecId, roiId;
        if(scenarioChoice === "2") {
          monthlyTableId = "preconisationMonthlyTableForced";
          monthlyChartId = "monthlyBarChartForced";
          twentyYearsId = "preconisationTableForced";
          puissanceId = "puissanceRecoForced";
          coutInstId = "coutInstallationForced";
          primeId = "primeValueForced";
          coutReelId = "coutReelInstallationForced";
          gainSansId = "gainSansInvForced";
          gainAvecId = "gainAvecInvForced";
          roiId = "roiResultForced";
        } else {
          monthlyTableId = "preconisationMonthlyTable";
          monthlyChartId = "monthlyBarChart";
          twentyYearsId = "preconisationTable";
          puissanceId = "puissanceReco";
          coutInstId = "coutInstallation";
          primeId = "primeValue";
          coutReelId = "coutReelInstallation";
          gainSansId = "gainSansInv";
          gainAvecId = "gainAvecInv";
          roiId = "roiResult";
        }
        await page2_TableauEtGraphique(pdf, scenarioChoice);
        // Suite (tableau projection, chiffres clés, etc.) identique...
        // Pour gagner en concision, ce bloc est inchangé par rapport à votre code existant.
        pdf.addPage();
        pdf.setFontSize(14);
        pdf.setTextColor(40,40,40);
        pdf.text("Projection sur 20 ans",10,15);
        let nextY3 = 20;
        const twentyTableEl = document.getElementById(twentyYearsId);
        if(twentyTableEl){
          pdf.autoTable({
            html: twentyTableEl,
            startY: nextY3,
            styles: { fontSize:8, cellPadding:2 },
            headStyles: { fillColor:[22,160,133], textColor:255, fontSize:9 }
          });
          const lastAuto = pdf.lastAutoTable;
          if(lastAuto){ nextY3 = lastAuto.finalY + 10; }
        } else { pdf.setFontSize(12); pdf.text("Aucun tableau de projection trouvé.",10,nextY3+5); nextY3 += 15; }
        pdf.setFontSize(14);
        pdf.text("Chiffres Clés",10,nextY3);
        nextY3 += 8;
        pdf.setFontSize(12);
        const pReco = document.getElementById(puissanceId)?.textContent || "-";
        const cInst = document.getElementById(coutInstId)?.textContent || "-";
        const cPrime = document.getElementById(primeId)?.textContent || "-";
        const cReel = document.getElementById(coutReelId)?.textContent || "-";
        const gSans = document.getElementById(gainSansId)?.textContent || "-";
        const gAvec = document.getElementById(gainAvecId)?.textContent || "-";
        const roiVal = document.getElementById(roiId)?.textContent || "-";
        pdf.text(`Puissance préconisée : ${pReco} kWc`,10,nextY3); nextY3 += 6;
        pdf.text(`Coût de l'installation : ${cInst} €`,10,nextY3); nextY3 += 6;
        pdf.text(`Prime : ${cPrime} €`,10,nextY3); nextY3 += 6;
        pdf.text(`Coût réel de l'installation : ${cReel} €`,10,nextY3); nextY3 += 6;
        pdf.text(`Gain total (sans inv.) : ${gSans} €`,10,nextY3); nextY3 += 6;
        pdf.text(`Gain total (avec inv.) : ${gAvec} €`,10,nextY3); nextY3 += 6;
        pdf.text(`ROI (années) : ${roiVal}`,10,nextY3);
        nextY3 += 12;
        pdf.setFontSize(12);
        const finalText = "Ce projet photovoltaïque vous apporte des bénéfices financiers tout en valorisant votre toiture et en participant à la transition énergétique. Grâce à une expertise FRH PRO, vous bénéficiez d'un accompagnement complet et de conseils personnalisés pour optimiser votre retour sur investissement.\n\nL'autoconsommation et la revente du surplus vous permettent de réduire vos factures d'électricité et de profiter d'une source de revenu durable.";
        const finalLines = pdf.splitTextToSize(finalText, 180);
        pdf.text(finalLines,10,nextY3);
        nextY3 += 20;
        let pdfFileName = "Rapport_Etude.pdf";
        if(companyName) { pdfFileName = `Rapport_${companyName}.pdf`; }
        pdf.save(pdfFileName);
        if(drawingCanvas && drawingCanvasParent) { drawingCanvasParent.appendChild(drawingCanvas); }
      } catch(e) { console.error("Erreur exportStudyReportPDF:", e); alert("Erreur lors de l'export PDF."); }
    }

    /********* SAUVEGARDER / CHARGER JSON *********/
    const saveButton = document.getElementById("saveToFile");
    const loadFileInput = document.getElementById("loadFromFile");
    const uploadButton = document.getElementById("uploadFile");
    saveButton.addEventListener("click", () => {
      const form = document.getElementById("userForm");
      const rawFormData = new FormData(form);
      const formObject = {};
      rawFormData.forEach((value, key) => {
        if(formObject[key] !== undefined){
          if(!Array.isArray(formObject[key])) { formObject[key] = [formObject[key]]; }
          formObject[key].push(value);
        } else { formObject[key] = value; }
      });
      const center = map.getCenter();
      formObject["mapCenterLat"] = center.lat;
      formObject["mapCenterLng"] = center.lng;
      formObject["mapZoom"] = map.getZoom();
      formObject["canvasImage"] = drawingCanvas.toDataURL();
      const shapesGeoJSON = drawnItems.toGeoJSON();
      formObject["drawnShapes"] = shapesGeoJSON;
      formObject["monthlyProductionData"] = monthlyProductionData;
      const companyName = formObject["companyName"] || "Formulaire";
      const fileName = `Formulaire_${companyName}.json`;
      const jsonString = JSON.stringify(formObject, null, 2);
      const blob = new Blob([jsonString], { type:"application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    });
    uploadButton.addEventListener("click", () => { loadFileInput.click(); });
    loadFileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e => {
          const jsonData = JSON.parse(e.target.result);
          const form = document.getElementById("userForm");
          Object.keys(jsonData).forEach(key => {
            if(["mapCenterLat","mapCenterLng","mapZoom","canvasImage","drawnShapes","monthlyProductionData"].includes(key)) return;
            const dataValue = jsonData[key];
            if(Array.isArray(dataValue)){
              dataValue.forEach(val => {
                const checkbox = form.querySelector(`[name="${key}"][value="${val}"]`);
                if(checkbox) { checkbox.checked = true; }
              });
            } else {
              const input = form.querySelector(`[name="${key}"]`);
              if(input) { input.value = dataValue; }
            }
          });
          if(jsonData["mapCenterLat"] !== undefined && jsonData["mapCenterLng"] !== undefined && jsonData["mapZoom"] !== undefined) {
            map.setView([jsonData["mapCenterLat"], jsonData["mapCenterLng"]], jsonData["mapZoom"]);
          }
          if(jsonData["canvasImage"]){
            const image = new Image();
            image.onload = function(){
              ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
              ctx.drawImage(image, 0, 0);
            };
            image.src = jsonData["canvasImage"];
          }
          if(jsonData["drawnShapes"]){
            drawnItems.clearLayers();
            L.geoJson(jsonData["drawnShapes"]).eachLayer(layer => { drawnItems.addLayer(layer); });
          }
          if(jsonData["monthlyProductionData"]){
            monthlyProductionData = jsonData["monthlyProductionData"];
            fillMonthlyProductionTable(monthlyProductionData);
          }
          for(let i = 0; i < 12; i++){ calculateCost(i); }
          updateProductionPotential();
        };
        reader.readAsText(file);
      }
    });

    /********* CALCUL DU COÛT PAR kWh *********/
    function calculateCost(index) {
      const eurosInput = document.getElementById(`euros_${index}`);
      const kwhInput = document.getElementById(`kwh_${index}`);
      const costCell = document.getElementById(`costPerKwh_${index}`);
      if(!eurosInput || !kwhInput || !costCell) return;
      const euros = parseFloat(eurosInput.value) || 0;
      const kwh = parseFloat(kwhInput.value) || 0;
      if(kwh > 0) {
        const costPerKwh = (euros / kwh).toFixed(2);
        costCell.textContent = `${costPerKwh} €`;
      } else { costCell.textContent = "-"; }
      calculateTotals();
    }
    function calculateTotals(){
      let totalEuros = 0, totalKwh = 0;
      for(let i = 0; i < 12; i++){
        const eurosVal = document.getElementById(`euros_${i}`);
        const kwhVal = document.getElementById(`kwh_${i}`);
        if(!eurosVal || !kwhVal) continue;
        totalEuros += parseFloat(eurosVal.value) || 0;
        totalKwh += parseFloat(kwhVal.value) || 0;
      }
      const averageCostPerKwh = totalKwh > 0 ? (totalEuros / totalKwh).toFixed(2) : "-";
      document.getElementById("totalEuros").textContent = totalEuros.toFixed(2).toLocaleString('fr-FR') + " €";
      document.getElementById("totalKwh").textContent = totalKwh.toFixed(2).toLocaleString('fr-FR') + " kWh";
      document.getElementById("totalCostPerKwh").textContent = averageCostPerKwh !== "-" ? `${averageCostPerKwh} €` : "-";
    }

    /********* CALCUL DE LA PRÉCONISATION (ONGLETS 8 & 9) *********/
    function costInstallation(S, territory){
      let raw = S <= 100 ? S * ((1.9093 - (0.00659 * S))) * 1000 : S * 1.15 * 1000;
      if(territory === "Corse") { raw *= 1.00; }
      else if(territory === "Reunion") { raw *= 1.13; }
      return Math.round(raw / 100) * 100;
    }
    function getTarifRachatAndPrime(S, territory){
      if(!primeTarifsData){
        console.warn("primeTarifsData introuvable");
        return { tarif: 0.0761, primeByWc: 0 };
      }
      const tData = primeTarifsData[territory] || primeTarifsData["France Metropolitaine"];
      let foundTarif = 0.0761, foundPrime = 0;
      if(tData && Array.isArray(tData.tarif_rachat)){
        for(const range of tData.tarif_rachat){
          if(S >= range.min && S <= range.max) { foundTarif = range.tarif; break; }
        }
      }
      if(tData && Array.isArray(tData.primes)){
        for(const range of tData.primes){
          if(S >= range.min && S <= range.max) { foundPrime = range.montant_euros_par_wc; break; }
        }
      }
      return { tarif: foundTarif, primeByWc: foundPrime };
    }
    function calculateROI(coutInstallation, autoYear1, surplusYear1, primeTotal, annualPriceIncrease){
      let cumulativeSavings = 0, roiYears = 0;
      while(roiYears < 100){
        roiYears++;
        const econAuto = autoYear1 * Math.pow(1 + annualPriceIncrease/100, roiYears - 1);
        const gainsRev = surplusYear1;
        const prime = (roiYears === 2) ? primeTotal : 0;
        cumulativeSavings += (econAuto + gainsRev + prime);
        if(cumulativeSavings >= coutInstallation) break;
      }
      return roiYears;
    }
    function computeAutoAndSurplusForPower(S, globalTarif){
      const ratioD = parseFloat(document.getElementById("ratioDiurne").value) || 50;
      const fractionClosed = (Array.from(document.querySelectorAll('input[name="joursConges[]"]:checked')).length) / 7;
      let totalGain = 0;
      for(let i = 0; i < 12; i++){
        const kwhInput = document.getElementById(`kwh_${i}`);
        const costCell = document.getElementById(`costPerKwh_${i}`);
        if(!kwhInput || !costCell || !monthlyProductionData[i]) continue;
        const consoKwh = parseFloat(kwhInput.value) || 0;
        const p_kWh = parseFloat(costCell.textContent) || 0;
        const E_m1kW = monthlyProductionData[i].E_m || 0;
        const production = S * E_m1kW;
        const forcedSurplus = fractionClosed * production;
        const leftover = production - forcedSurplus;
        const autoCons = Math.min(leftover, consoKwh * (ratioD/100));
        totalGain += autoCons * p_kWh;
      }
      return totalGain;
    }
    function calculatePreconisationWithPower(S, firstYearGain, territoryObj){
      fillMonthlyPreconisation(S, territoryObj.tarif);
      fill20YearsPreconisation(S, firstYearGain, territoryObj);
    }
    // Les fonctions fillMonthlyPreconisation, createMonthlyBarChart, fill20YearsPreconisation,
    // et leurs versions "Forced" restent inchangées (voir code complet ci‑dessous)
    // ... (code existant pour onglets 8 & 9) ...

    /********* MODULE : PLAN DE TRÉSORERIE (ONGLET 12) *********/
    function calculatePlanTresorerie(){
      // Sélection mode financement et scénario
      const financementMode = document.getElementById("financementMode").value; // "banque" ou "leasing"
      const scenarioPlan = document.getElementById("scenarioPlan").value; // "standard" ou "selection"
      
      // Récupération des projections de l'onglet préconisation selon scénario
      let autoYear1_val, surplus_val;
      if(scenarioPlan === "standard"){
        autoYear1_val = parseFloat(document.getElementById("monthlyTotalAuto").textContent.replace("€","").trim());
        surplus_val = parseFloat(document.getElementById("monthlyTotalRevente").textContent.replace("€","").trim());
      } else {
        autoYear1_val = parseFloat(document.getElementById("monthlyTotalAutoForced").textContent.replace("€","").trim());
        surplus_val = parseFloat(document.getElementById("monthlyTotalReventeForced").textContent.replace("€","").trim());
      }
      const recettesExploitation = autoYear1_val + surplus_val; // Recettes de la 1ère année
      
      const preconIncrease = parseFloat(document.getElementById("annualPriceIncrease").value) || 5;
      // Coût d'installation HT
      let installationCostHT = 0;
      if(scenarioPlan === "standard"){
        installationCostHT = parseFloat(document.getElementById("coutInstallation").textContent.replace(/[^0-9.]/g,"")) || 0;
      } else {
        installationCostHT = parseFloat(document.getElementById("coutInstallationForced").textContent.replace(/[^0-9.]/g,"")) || 0;
      }
      const installationPower = parseFloat(document.getElementById("puissanceMaxPV").value) || 0;
      
      // Paramètres de l'onglet Paramètres
      const assurance_dommages = parseFloat(document.getElementById("assurance_dommages").value) || 0;
      const assurance_perte = parseFloat(document.getElementById("assurance_perte").value) || 0;
      const cout_maintenance = parseFloat(document.getElementById("cout_maintenance").value) || 0;
      const cout_changement_onduleurs = parseFloat(document.getElementById("cout_changement_onduleurs").value) || 0;
      const inflation = parseFloat(document.getElementById("inflation_estimee").value) || 0;
      const taux_emprunt = parseFloat(document.getElementById("taux_emprunt").value) || 0;
      const duree_pret = parseFloat(document.getElementById("duree_pret").value) || 0;
      const index_leasing = parseFloat(document.getElementById("index_leasing").value) || 0;
      const duree_leasing = parseFloat(document.getElementById("duree_leasing").value) || 0;
      
      // Calcul financement
      let annualRepayment = 0;
      if(financementMode === "banque" && duree_pret > 0){
        const n = duree_pret * 12;
        const i = taux_emprunt / 100 / 12;
        const monthlyPayment = installationCostHT * (i * Math.pow(1+i, n)) / (Math.pow(1+i, n)-1);
        annualRepayment = monthlyPayment * 12;
      }
      let annualLeasing = 0;
      if(financementMode === "leasing" && duree_leasing > 0){
        // Pour leasing, la durée effective est duree_leasing/12 années
        annualLeasing = installationCostHT * (index_leasing/100) * 12;
      }
      
      // Pour chaque année (1 à 20)
      const tableBody = document.getElementById("planTresorerieBody");
      tableBody.innerHTML = "";
      for(let year = 1; year <= 20; year++){
        // Indexation par inflation pour charges et assurance
        const factor = Math.pow(1 + inflation/100, year-1);
        // Charges d'exploitation : maintenance + nettoyage indexés, ajout du remplacement onduleurs à l'année 11
        let chargesExploitation = (installationCostHT * (assurance_dommages + assurance_perte) + installationPower * cout_maintenance) * factor;
        if(year === 11){ chargesExploitation += cout_changement_onduleurs; }
        // Assurance photovoltaïque
        const assurancePhoto = installationCostHT * (assurance_dommages + assurance_perte) * factor;
        const totalCharges = chargesExploitation + assurancePhoto;
        // Financement
        let financementCost = 0;
        if(financementMode === "banque"){
          financementCost = (year <= duree_pret) ? annualRepayment : 0;
        } else {
          financementCost = (year <= (duree_leasing/12)) ? annualLeasing : 0;
        }
        const soldeNet = recettesExploitation - (totalCharges + financementCost);
        // Création de la ligne
        const row = document.createElement("tr");
        row.innerHTML = `<td>${year}</td>
          <td>${recettesExploitation.toFixed(2)} €</td>
          <td>${chargesExploitation.toFixed(2)} €</td>
          <td>${assurancePhoto.toFixed(2)} €</td>
          <td>${totalCharges.toFixed(2)} €</td>
          <td>${financementCost.toFixed(2)} €</td>
          <td>${soldeNet.toFixed(2)} €</td>`;
        tableBody.appendChild(row);
      }
    }
    // Bouton sur l'onglet 12
    const calculateTresorerieBtn = document.getElementById("calculateTresorerieBtn");
    calculateTresorerieBtn.addEventListener("click", calculatePlanTresorerie);

    /********* SAUVEGARDER / CHARGER JSON *********/
    const saveButton = document.getElementById("saveToFile");
    const loadFileInput = document.getElementById("loadFromFile");
    const uploadButton = document.getElementById("uploadFile");
    saveButton.addEventListener("click", () => {
      const form = document.getElementById("userForm");
      const rawFormData = new FormData(form);
      const formObject = {};
      rawFormData.forEach((value, key) => {
        if(formObject[key] !== undefined){
          if(!Array.isArray(formObject[key])) { formObject[key] = [formObject[key]]; }
          formObject[key].push(value);
        } else { formObject[key] = value; }
      });
      const center = map.getCenter();
      formObject["mapCenterLat"] = center.lat;
      formObject["mapCenterLng"] = center.lng;
      formObject["mapZoom"] = map.getZoom();
      formObject["canvasImage"] = drawingCanvas.toDataURL();
      const shapesGeoJSON = drawnItems.toGeoJSON();
      formObject["drawnShapes"] = shapesGeoJSON;
      formObject["monthlyProductionData"] = monthlyProductionData;
      const companyName = formObject["companyName"] || "Formulaire";
      const fileName = `Formulaire_${companyName}.json`;
      const jsonString = JSON.stringify(formObject, null, 2);
      const blob = new Blob([jsonString], { type:"application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
    });
    uploadButton.addEventListener("click", () => { loadFileInput.click(); });
    loadFileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e => {
          const jsonData = JSON.parse(e.target.result);
          const form = document.getElementById("userForm");
          Object.keys(jsonData).forEach(key => {
            if(["mapCenterLat","mapCenterLng","mapZoom","canvasImage","drawnShapes","monthlyProductionData"].includes(key)) return;
            const dataValue = jsonData[key];
            if(Array.isArray(dataValue)){
              dataValue.forEach(val => {
                const checkbox = form.querySelector(`[name="${key}"][value="${val}"]`);
                if(checkbox){ checkbox.checked = true; }
              });
            } else {
              const input = form.querySelector(`[name="${key}"]`);
              if(input){ input.value = dataValue; }
            }
          });
          if(jsonData["mapCenterLat"] !== undefined && jsonData["mapCenterLng"] !== undefined && jsonData["mapZoom"] !== undefined) {
            map.setView([jsonData["mapCenterLat"], jsonData["mapCenterLng"]], jsonData["mapZoom"]);
          }
          if(jsonData["canvasImage"]){
            const image = new Image();
            image.onload = function(){
              ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
              ctx.drawImage(image, 0, 0);
            };
            image.src = jsonData["canvasImage"];
          }
          if(jsonData["drawnShapes"]){
            drawnItems.clearLayers();
            L.geoJson(jsonData["drawnShapes"]).eachLayer(layer => { drawnItems.addLayer(layer); });
          }
          if(jsonData["monthlyProductionData"]){
            monthlyProductionData = jsonData["monthlyProductionData"];
            fillMonthlyProductionTable(monthlyProductionData);
          }
          for(let i = 0; i < 12; i++){ calculateCost(i); }
          updateProductionPotential();
        };
        reader.readAsText(file);
      }
    });
    /********* CALCUL DU COÛT PAR kWh *********/
    function calculateCost(index){
      const eurosInput = document.getElementById(`euros_${index}`);
      const kwhInput = document.getElementById(`kwh_${index}`);
      const costCell = document.getElementById(`costPerKwh_${index}`);
      if(!eurosInput || !kwhInput || !costCell) return;
      const euros = parseFloat(eurosInput.value) || 0;
      const kwh = parseFloat(kwhInput.value) || 0;
      if(kwh > 0) { costCell.textContent = (euros/kwh).toFixed(2) + " €"; }
      else { costCell.textContent = "-"; }
      calculateTotals();
    }
    function calculateTotals(){
      let totalEuros = 0, totalKwh = 0;
      for(let i = 0; i < 12; i++){
        const eurosVal = document.getElementById(`euros_${i}`);
        const kwhVal = document.getElementById(`kwh_${i}`);
        if(!eurosVal || !kwhVal) continue;
        totalEuros += parseFloat(eurosVal.value) || 0;
        totalKwh += parseFloat(kwhVal.value) || 0;
      }
      document.getElementById("totalEuros").textContent = totalEuros.toFixed(2).toLocaleString('fr-FR') + " €";
      document.getElementById("totalKwh").textContent = totalKwh.toFixed(2).toLocaleString('fr-FR') + " kWh";
      const average = totalKwh > 0 ? (totalEuros/totalKwh).toFixed(2) : "-";
      document.getElementById("totalCostPerKwh").textContent = average !== "-" ? `${average} €` : "-";
    }

    /********* Initialisation de Flatpickr *********/
    flatpickr("#rdvDate", { locale: "fr", dateFormat: "d/m/Y" });
  </script>
</body>
</html>
